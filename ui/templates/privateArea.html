<!DOCTYPE html>
<html>
    <head>
        <title>Private area</title>
        
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">  

        <script>
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            function removeAllCookies() {
                var allCookies = document.cookie.split(';'); 
                
                for (var i = 0; i < allCookies.length; i++){   // set the expiration date to 01/01/
                    document.cookie = allCookies[i] + "=;expires=" + new Date(0).toUTCString(); 
                }
            }
                    
            function getAuthenticationParams() {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        let data = JSON.parse(this.response);
                        if (data.authenticated == false){
                            alert("You must be authenticated to access the private area.");
                            removeAllCookies();
                            window.location.href = "/login";
                        }else{
                            document.getElementById("welcome").innerHTML = `Welcome back <b>${data.data.email}</b>`;
                        }
                    }
                };

                xhttp.open("GET", `http://localhost:5001/isAuthenticated?token=${getCookie("token")}`, true);
                xhttp.setRequestHeader('Access-Control-Allow-Origin', '*'); 
                xhttp.setRequestHeader('Access-Control-Allow-Methods', 'GET, PUT, POST, DELETE, OPTIONS');
                xhttp.setRequestHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With')
                xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhttp.send()
            }
        </script>
    </head>
    <body>
        <!-- Nav Bar -->
        {% include "navbar.html" %}

        <div class="container">
            <h2>Welcome back!</h2>
            <p id="welcome"></p>

        </div>
        <script>
            getAuthenticationParams();
        </script>
    </body>
</html>