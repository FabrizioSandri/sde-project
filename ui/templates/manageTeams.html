<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		div[id^="listTeams"] {
		  background-color: lightblue;
		  margin: 20px;
		  padding: 10px;
		  text-align: center;
		}
	</style>
    <title>Teams Information</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">


	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script>
      function loadTeams() {
		var teamsContainer = document.getElementById("teamsContainer");
		teamsContainer.innerHTML = "";
        // Make initial request to get userTeamsOfInterest
        fetch(`http://localhost:5002/userTeamsOfInterest?token=${getCookie("token")}`,{
          method: 'GET',
          mode: 'cors'
        })
          .then(response => response.json())
          .then(data => {
            // Loop through the array of teams and make a request for each team
            data.result.forEach(team => {
							if (team.hasOwnProperty("teamId") && team.hasOwnProperty("leagueId")){
								fetch(`http://localhost:5002/getTeamInfoById?teamId=${team.teamId}&leagueId=${team.leagueId}`,{
									method: 'GET',
									mode: 'cors'
								})
									.then(response => response.json())
									.then(data => {
														console.log("data:"+JSON.stringify(data))
														if(data.status=="success" && data.hasOwnProperty("teamInfo")){
															console.log(data.teamInfo);

															// Create a container for each team
															const teamContainer = document.createElement("div");
															teamContainer.innerHTML = `
																Team Name: ${data.teamInfo.team.name} - 
																Country: ${data.teamInfo.team.country} - 
																Stadium: ${data.teamInfo.venue.name} 
																<img src=${data.teamInfo.team.logo} width="50" height="70">
																<button onclick="removeTeam(${data.teamInfo.team.id})">Remove Team</button>
															`;
															// Append the container to the main container
															document.getElementById("teamsContainer").appendChild(teamContainer);
														}
									})
									.catch(error => console.error("Error fetching team information:", error));
								}
						});
          })
          .catch(error => console.error("Error fetching userTeamsOfInterest:", error));
      }
      
      function removeTeam(id) {
      
      	fetch(`http://localhost:5002/removeTeamOfInterest`,{
          method: 'POST',
          mode: 'cors',
      		headers:{
            'Content-Type': 'application/x-www-form-urlencoded'
          },    
          body: new URLSearchParams({
              'token': getCookie("token"),
              'teamId': id,
          }),
      		json: true
        })
      	.then(response => response.json())
      	.then( data => {
      		if(data.status=="success"){
				loadTeams();
      		}
      		else{
      			alert("something went wrong: " + JSON.stringify(data));
      		}
      	})
      	.catch(error => console.error("Error trying to call the removing team function"))
      }
      
      function showLeagues(){
      	
      	fetch(`http://localhost:5002/getLeagues`,{
          method: 'GET',
          mode: 'cors'
        	})
      	.then(response => response.json())
      	.then(data => {
      		// Loop through the array of teams and make a request for each team
      		data.leagues.forEach(league => {
      			// Create a container for each league
      			const leagueContainer = document.createElement("div");
      			leagueContainer.innerHTML = `
      				<p>League Name: ${league.name} - 
      					country: ${league.country}
      					<button onclick=getTeamsOfLeague(${league.id})>View Teams</button>	
      					<div id="listTeams${league.id}" style="display:none;"></div>
      				</p>
      			`;
      			// Append the container to the main container
      			document.getElementById("leaguesAndTeams").appendChild(leagueContainer);
      		})
        })
      	.catch(error => console.error("Error fetching team information:", error));
      }
      
    function getTeamsOfLeague(leagueId){
			var listTeamsContainer = document.getElementById(`listTeams${leagueId}`);
			if(listTeamsContainer.style.display==="none" && listTeamsContainer.hasChildNodes()){
				listTeamsContainer.style.display = "block";
			}
			else if (listTeamsContainer.style.display==="none"){
				fetch(`http://localhost:5002/getTeamsByLeagueId?leagueId=${leagueId}`,{
					method: 'GET',
					mode: 'cors'
				})
				.then(response => response.json())
				.then(data => {
					data.teams.forEach(team=>{
						// Create a container for each team
						const teamContainer = document.createElement("div");
						teamContainer.innerHTML = 
							`<p>
								Team Name: ${team.name} - 
								<img src=${team.logo} width="50" height="70"> 
								<button onclick="addTeam(${team.id},${leagueId})">Add Team</button>
							</p>
						`;
						// Append the container to the main container
						listTeamsContainer.appendChild(teamContainer);
						listTeamsContainer.style.display = "block";
					})
				})
				.catch(error => console.error("Error fetching team information:", error));
			}
			else {
					listTeamsContainer.style.display = "none";
				}
    }
      
      function addTeam(teamId, leagueId) {
      	fetch(`http://localhost:5002/addTeamOfInterest`,{
      		method: 'POST',
      		mode: 'cors',
      		headers:{
      			'Content-Type': 'application/x-www-form-urlencoded'
      		},    
      		body: new URLSearchParams({
      				'token': getCookie("token"),
      				'teamId': teamId,
      				'leagueId': leagueId,
      		}),
      		json: true
      	})
      	.then(response => response.json())
      	.then( data => {
      		console.log(data);
      		if(data.status=="success"){
      				loadTeams();
      			}
      		else{
      			alert("something went wrong: " + JSON.stringify(data));
      		}
      	})
      	.catch(error => console.error("Error trying to call the add team function"))
      }

		function getCookie(name) {
			const value = `; ${document.cookie}`;
			const parts = value.split(`; ${name}=`);
			if (parts.length === 2) 
				return parts.pop().split(';').shift();
		}
		
    </script>

  </head>
  <body>
    <h1>Manage your teams</h1>
    <h2>Your teams:</h2>
    <div id="teamsContainer"></div>
    <hr>
    <h2>Add new teams:</h2>
    <button onclick="showLeagues()">Want to add a new team to my interests?</button>
    <div id="leaguesAndTeams"></div>
	<script>loadTeams();</script>
  </body>
</html>

