version: "3.8"
services:

  # Process centric
  authentication:
    build: ./process_centric/authentication
    restart: always
    environment:
      - LOGIN_SERVICE_PORT
      - REGISTRATION_SERVICE_PORT
      - EXPRESS_SESSION_SECRET
      - GOOGLE_CLIENT_ID
      - GOOGLE_CLIENT_SECRET
      - GOOGLE_CALLBACK_URL
      - JWT_SECRET
      - AUTHENTICATION_SERVER_PORT
    ports:
      - ${AUTHENTICATION_SERVER_PORT}:${AUTHENTICATION_SERVER_PORT}
    expose:
      - ${AUTHENTICATION_SERVER_PORT}
    depends_on:
      - login
      - registration


  # Business logic
  login:
    build: ./business_logic/login
    restart: always
    environment:
      - DB_ADAPTER_SERVER_PORT
      - JWT_SECRET
      - LOGIN_SERVICE_PORT
    ports:
      - ${LOGIN_SERVICE_PORT}:${LOGIN_SERVICE_PORT}
    expose:
      - ${LOGIN_SERVICE_PORT}
    depends_on:
      - db_adapter

  registration:
    build: ./business_logic/registration
    restart: always
    environment:
      - EVA_ADAPTER_SERVER_PORT
      - DB_ADAPTER_SERVER_PORT
      - REGISTRATION_SERVICE_PORT
    ports:
      - ${REGISTRATION_SERVICE_PORT}:${REGISTRATION_SERVICE_PORT}
    expose:
      - ${REGISTRATION_SERVICE_PORT}
    depends_on:
      - db_adapter
      - eva_adapter

  news_aggregator:
    build: ./business_logic/news_aggregator
    restart: always
    environment:
      - NEWS_AGGREGATOR_SERVICE_PORT
      - RSS_ADAPTER_SERVER_PORT
    ports:
      - ${NEWS_AGGREGATOR_SERVICE_PORT}:${NEWS_AGGREGATOR_SERVICE_PORT}
    expose:
      - ${NEWS_AGGREGATOR_SERVICE_PORT}
    depends_on:
      - html_adapter
      - rss_adapter

  # Adapter Layer
  eva_adapter:
    build: ./adapter/eva_api
    restart: always
    environment:
      - EVA_ADAPTER_SERVER_PORT
    ports:
      - ${EVA_ADAPTER_SERVER_PORT}:${EVA_ADAPTER_SERVER_PORT}
    expose:
      - ${EVA_ADAPTER_SERVER_PORT}

  db_adapter:
    build: ./adapter/database_interface
    restart: always
    environment:
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD
      - DB_PORT
      - DB_ADAPTER_SERVER_PORT
    ports:
      - ${DB_ADAPTER_SERVER_PORT}:${DB_ADAPTER_SERVER_PORT}
    expose:
      - ${DB_ADAPTER_SERVER_PORT}
    depends_on:
      - database

  rss_adapter:
    build: ./adapter/rss_feed
    restart: always
    environment:
      - RSS_ADAPTER_SERVER_PORT
    ports:
      - ${RSS_ADAPTER_SERVER_PORT}:${RSS_ADAPTER_SERVER_PORT}
    expose:
      - ${RSS_ADAPTER_SERVER_PORT}
    # flask requires SIGINT to stop gracefully
    # (default stop signal from Compose is SIGTERM)
    stop_signal: SIGINT

  html_adapter:
    build: ./adapter/html_adapter
    restart: always
    environment:
      - HTML_ADAPTER_SERVER_PORT
    ports:
      - ${HTML_ADAPTER_SERVER_PORT}:${HTML_ADAPTER_SERVER_PORT}
    expose:
      - ${HTML_ADAPTER_SERVER_PORT}
    # flask requires SIGINT to stop gracefully
    # (default stop signal from Compose is SIGTERM)
    stop_signal: SIGINT

  # Data layer
  database:
    image: mysql
    restart: always
    environment:
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD
      - MYSQL_ROOT_PASSWORD
    expose:
      - ${DB_PORT}
    volumes:
      - ./adapter/database_interface/mysql-dump/users.sql:/docker-entrypoint-initdb.d/users.sql
      - persistent-db:/var/lib/mysql

volumes:
  persistent-db: